{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Optimizaci√≥n de Rutas</title>
  <link rel="stylesheet" href="{% static 'css/base/_reset.css' %}">
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  <style>
    #map {
      height: 500px;
      width: 100%;
      margin: 20px auto;
      border-radius: 10px;
      border: 2px solid #ddd;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    th {
      background-color: #007bff;
      color: #fff;
    }
    .legend {
      margin-top: 15px;
      font-size: 14px;
    }
    .legend span {
      display: inline-block;
      margin-right: 15px;
    }
    .blue { color: blue; font-weight: bold; }
    .red { color: red; font-weight: bold; }
    .green { color: green; font-weight: bold; }
  </style>
</head>
<body>

{% include 'includes/navbar.html' %}

<h1>Optimizaci√≥n de Rutas</h1>

<div id="map"></div>

<!-- Leyenda -->
<div class="legend">
  <span class="blue">‚óè Ruta Google Maps</span>
  <span class="red">‚óè Ruta Algoritmo</span>
  <span class="green">‚óè Ruta Real (mensajero)</span>
</div>

<!-- Tabla comparativa -->
<table>
  <thead>
    <tr>
      <th>Tipo de Ruta</th>
      <th>Duraci√≥n (min)</th>
      <th>Distancia (km)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Google Maps</td>
      <td>{{ ruta_google.duracion }}</td>
      <td>{{ ruta_google.distancia }}</td>
    </tr>
    <tr>
      <td>Algoritmo</td>
      <td>{{ ruta_algo.duracion }}</td>
      <td>{{ ruta_algo.distancia }}</td>
    </tr>
    <tr>
      <td>Real (mensajero)</td>
      <td>{% if ruta_real.duracion %}{{ ruta_real.duracion }}{% else %}--{% endif %}</td>
      <td>{% if ruta_real.distancia %}{{ ruta_real.distancia }}{% else %}--{% endif %}</td>
    </tr>
  </tbody>
</table>

<!-- JSON con los datos -->
<script id="rutas-data" type="application/json">
  {
    "google": {
      "polyline": "{{ ruta_google.polyline|default_if_none:''|escapejs }}",
      "duracion": "{{ ruta_google.duracion|default_if_none:'' }}",
      "distancia": "{{ ruta_google.distancia|default_if_none:'' }}"
    },
    "algoritmo": {
      "polyline": "{{ ruta_algo.polyline|default_if_none:''|escapejs }}",
      "duracion": "{{ ruta_algo.duracion|default_if_none:'' }}",
      "distancia": "{{ ruta_algo.distancia|default_if_none:'' }}"
    },
    "real": {
      "polyline": "{{ ruta_real.polyline|default_if_none:''|escapejs }}",
      "duracion": "{{ ruta_real.duracion|default_if_none:'' }}",
      "distancia": "{{ ruta_real.distancia|default_if_none:'' }}"
    },
    "puntos": {{ puntos|safe }}
  }
</script>

<script>
function initMap() {
  const center = { lat: -16.5, lng: -68.15 };
  const map = new google.maps.Map(document.getElementById("map"), {
    zoom: 12,
    center: center
  });

  const data = JSON.parse(document.getElementById("rutas-data").textContent);

  // ==================
  // üîπ Mostrar puntos
  // ==================
  if (data.puntos && data.puntos.length > 0) {
    data.puntos.forEach(p => {
      let color = p.tipo === "Recojo" ? "blue" : "orange";
      let label = p.tipo === "Recojo" ? "R" : "E";
      new google.maps.Marker({
        position: {lat: p.lat, lng: p.lng},
        map: map,
        label: label,
        title: `${p.tipo} - Env√≠o ${p.id} (${p.direccion})`
      });
    });
  }

  // ==================
  // üîπ Decodificar polylines
  // ==================
  function decodePolyline(encoded) {
    if (!encoded) return [];
    let points = [];
    let index = 0, len = encoded.length;
    let lat = 0, lng = 0;

    while (index < len) {
      let b, shift = 0, result = 0;
      do {
        b = encoded.charCodeAt(index++) - 63;
        result |= (b & 0x1f) << shift;
        shift += 5;
      } while (b >= 0x20);
      let dlat = (result & 1) ? ~(result >> 1) : (result >> 1);
      lat += dlat;

      shift = 0;
      result = 0;
      do {
        b = encoded.charCodeAt(index++) - 63;
        result |= (b & 0x1f) << shift;
        shift += 5;
      } while (b >= 0x20);
      let dlng = (result & 1) ? ~(result >> 1) : (result >> 1);
      lng += dlng;

      points.push({lat: lat / 1e5, lng: lng / 1e5});
    }
    return points;
  }

  // ==================
  // üîπ Dibujar rutas
  // ==================
  const googlePath = decodePolyline(data.google.polyline);
  const algoPath = decodePolyline(data.algoritmo.polyline);
  const realPath = decodePolyline(data.real.polyline);

  if (googlePath.length > 0) {
    new google.maps.Polyline({
      path: googlePath,
      geodesic: true,
      strokeColor: "blue",
      strokeOpacity: 0.8,
      strokeWeight: 5,
      map: map
    });
  }

  if (algoPath.length > 0) {
    new google.maps.Polyline({
      path: algoPath,
      geodesic: true,
      strokeColor: "red",
      strokeOpacity: 0.8,
      strokeWeight: 4,
      map: map
    });
  }

  if (realPath.length > 0) {
    new google.maps.Polyline({
      path: realPath,
      geodesic: true,
      strokeColor: "green",
      strokeOpacity: 0.8,
      strokeWeight: 4,
      map: map
    });
  }

  // ==================
  // üîπ Ajustar mapa
  // ==================
  const bounds = new google.maps.LatLngBounds();
  [...googlePath, ...algoPath, ...realPath].forEach(p => bounds.extend(p));
  if (data.puntos) {
    data.puntos.forEach(p => bounds.extend({lat: p.lat, lng: p.lng}));
  }
  if (!bounds.isEmpty()) map.fitBounds(bounds);
}
</script>

<!-- Google Maps API -->
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBN30lGA4NxW7R3OcIfK1DqxJmavBMAw1U&callback=initMap" async defer></script>

</body>
</html>
