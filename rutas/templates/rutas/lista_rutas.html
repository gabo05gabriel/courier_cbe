{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sobres por Mensajero</title>
    <!-- Enlazar los archivos CSS -->
    <link rel="stylesheet" href="{% static 'css/base/_reset.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'css/_listas.css' %}">
    <style>
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        th { background-color: #007bff; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        #map { height: 400px; width: 100%; margin-top: 30px; }
        .btn-optimizar {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 15px;
            background: green;
            color: #fff;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
        }
        .btn-optimizar:hover {
            background: darkgreen;
        }
    </style>
</head>
<body>

    <!-- Navbar global -->
    {% include 'includes/navbar.html' %}

    <h1>Lista de Sobres por Mensajero</h1>

    <!-- Formulario de selecciÃ³n -->
    <form method="POST">
        {% csrf_token %}
        <label for="mensajero">Seleccionar Mensajero:</label>
        <select name="mensajero_id" id="mensajero">
            <option value="">-- Selecciona un mensajero --</option>
            {% for mensajero in mensajeros %}
                <option value="{{ mensajero.id }}" {% if mensajero.id|stringformat:"s" == request.POST.mensajero_id %}selected{% endif %}>
                    {{ mensajero.nombre }}
                </option>
            {% endfor %}
        </select>
        <button type="submit">Filtrar</button>
    </form>

    <!-- âœ… BotÃ³n para optimizar rutas (solo aparece si hay mensajero seleccionado) -->
    {% if request.POST.mensajero_id %}
        <a href="{% url 'optimizar_rutas' request.POST.mensajero_id %}" class="btn-optimizar">ðŸš€ Optimizar Rutas</a>
    {% endif %}

    <!-- Tabla de sobres -->
    {% if sobres_json != "[]" %}
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Origen</th>
                    <th>Destino</th>
                    <th>Destinatario</th>
                    <th>TelÃ©fono</th>
                    <th>Peso</th>
                    <th>Tipo Servicio</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Observaciones</th>
                    <th>Creado en</th>
                    <th>Monto Pago</th>
                    <th>Tipo Pago</th>
                    <th>Remitente</th>
                    <th>TelÃ©fono Remitente</th>
                </tr>
            </thead>
            <tbody id="sobres-table-body">
                <!-- Se llena dinÃ¡micamente con JS -->
            </tbody>
        </table>
    {% else %}
        <p>No hay sobres para este mensajero.</p>
    {% endif %}

    <!-- Contenedor del mapa -->
    <div id="map"></div>

    <!-- Script con sobres -->
    <script id="sobres-data" type="application/json">
        {{ sobres_json|safe }}
    </script>

    <!-- Script del mapa -->
    <script>
        function initMap() {
            const laPaz = { lat: -16.5, lng: -68.1193 };
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: laPaz
            });

            const sobres = JSON.parse(document.getElementById("sobres-data").textContent);
            const tableBody = document.getElementById("sobres-table-body");

            sobres.forEach(function(sobre) {
                // Render tabla
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${sobre.id}</td>
                    <td>${sobre.origen_direccion}</td>
                    <td>${sobre.destino_direccion}</td>
                    <td>${sobre.destinatario_nombre}</td>
                    <td>${sobre.destinatario_telefono}</td>
                    <td>${sobre.peso}</td>
                    <td>${sobre.tipo_servicio}</td>
                    <td>${sobre.tipo}</td>
                    <td>${sobre.estado}</td>
                    <td>${sobre.observaciones || ""}</td>
                    <td>${sobre.creado_en}</td>
                    <td>${sobre.monto_pago}</td>
                    <td>${sobre.tipo_pago}</td>
                    <td>${sobre.remitente_nombre}</td>
                    <td>${sobre.remitente_telefono}</td>
                `;
                tableBody.appendChild(row);

                // Marcadores en el mapa segÃºn tipo
                if (sobre.tipo === "Recojo" && sobre.origen && sobre.origen.lat && sobre.origen.lng) {
                    new google.maps.Marker({
                        position: sobre.origen,
                        map: map,
                        label: "R",
                        title: "Recojo - Sobre " + sobre.id
                    });
                }

                if (sobre.tipo === "EnvÃ­o" && sobre.destino && sobre.destino.lat && sobre.destino.lng) {
                    new google.maps.Marker({
                        position: sobre.destino,
                        map: map,
                        label: "E",
                        title: "EnvÃ­o - Sobre " + sobre.id
                    });
                }
            });

            // Ajustar vista
            if (sobres.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                sobres.forEach(sobre => {
                    if (sobre.tipo === "Recojo" && sobre.origen && sobre.origen.lat && sobre.origen.lng) {
                        bounds.extend(sobre.origen);
                    }
                    if (sobre.tipo === "EnvÃ­o" && sobre.destino && sobre.destino.lat && sobre.destino.lng) {
                        bounds.extend(sobre.destino);
                    }
                });
                if (!bounds.isEmpty()) {
                    map.fitBounds(bounds);
                }
            }
        }
    </script>

    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBN30lGA4NxW7R3OcIfK1DqxJmavBMAw1U&callback=initMap" async defer></script>

</body>
</html>
