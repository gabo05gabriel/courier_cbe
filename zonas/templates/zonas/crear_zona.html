{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Zona</title>
    <!-- Cargar archivos estáticos de Django -->
    <link rel="stylesheet" href="{% static 'css/base/_reset.css' %}">
    <link rel="stylesheet" href="{% static 'css/components/_forms.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body>
    <h1>Crear Nueva Zona</h1>

    <form method="POST">
        {% csrf_token %}
        {{ form.as_p }}  <!-- Aquí vienen nombre y otros campos -->

        <!-- Mapa para seleccionar el área -->
        <h2>Seleccionar área en el mapa</h2>
        <div id="map" style="height: 400px; width: 100%; margin-top: 20px;"></div>

        <!-- Campo oculto para las coordenadas del polígono -->
        <input type="hidden" name="zona_area" id="id_zona_area">

        <button type="submit">Guardar</button>
    </form>

    <a href="{% url 'lista_zonas' %}">Volver a la lista de zonas</a>

    <script>
        let map;
        let drawingManager;
        let selectedShape;
        let zoneAreaCoordinates = [];

        function initMap() {
            // Posición inicial (La Paz, Bolivia)
            const initialPosition = { lat: -16.5, lng: -68.1193 };

            // Crear el mapa
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: initialPosition,
            });

            // Configuración del DrawingManager para permitir el dibujo de polígonos
            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.POLYGON,  // Solo permite dibujar polígonos
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: [google.maps.drawing.OverlayType.POLYGON],
                },
                polygonOptions: {
                    editable: true,  // Permite editar el polígono
                    draggable: true,  // Permite mover el polígono
                },
            });

            drawingManager.setMap(map);

            // Cuando se termina de dibujar el polígono
            google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
                if (event.type === google.maps.drawing.OverlayType.POLYGON) {
                    // Eliminar el polígono anterior si existe
                    if (selectedShape) {
                        selectedShape.setMap(null);
                    }

                    // Guardar el nuevo polígono
                    selectedShape = event.overlay;
                    zoneAreaCoordinates = selectedShape.getPath().getArray(); // Obtener las coordenadas del polígono

                    // Crear un array para las coordenadas (latitud, longitud)
                    const coordinates = zoneAreaCoordinates.map(function(latLng) {
                        return { lat: latLng.lat(), lng: latLng.lng() };
                    });

                    // Mostrar las coordenadas en el input oculto del formulario
                    document.getElementById('id_zona_area').value = JSON.stringify(coordinates);
                }
            });
        }
    </script>

    <!-- Cargar la API de Google Maps con la librería de dibujo -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBN30lGA4NxW7R3OcIfK1DqxJmavBMAw1U&callback=initMap&libraries=drawing" async defer></script>
</body>
</html>
